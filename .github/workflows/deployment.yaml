name: Image build

on:
  workflow_dispatch:
    inputs:
      image:
        required: true
        description: Image a build
        type: choice
        options:
          - grav
          - vault
          - terraform-agent
          - mongo
      tag:
        required: false
        description: Tag custom (sinon utilise le SHA du commit)
  push:
    branches: [master]
    paths:
      - 'grav/**'
      - 'vault/**'
      - 'terraform-agent/**'
      - 'mongo/**'

jobs:
  detect-changes:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    outputs:
      images: ${{ steps.changes.outputs.images }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 2
      - id: changes
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD | cut -d'/' -f1 | sort -u)
          IMAGES=()
          for dir in grav vault terraform-agent mongo; do
            if echo "$CHANGED" | grep -q "^${dir}$"; then
              IMAGES+=("\"${dir}\"")
            fi
          done
          echo "images=[$(IFS=,; echo "${IMAGES[*]}")]" >> $GITHUB_OUTPUT

  build-push:
    if: github.event_name == 'push'
    needs: detect-changes
    strategy:
      matrix:
        image: ${{ fromJson(needs.detect-changes.outputs.images) }}
    uses: ClubCedille/cedille-workflows/.github/workflows/build-push-ghcr.yaml@master
    with:
      container-name: ${{ matrix.image }}
      context: ./${{ matrix.image }}
      file: ./${{ matrix.image }}/Dockerfile
    secrets: inherit

  build-dispatch:
    if: github.event_name == 'workflow_dispatch'
    uses: ClubCedille/cedille-workflows/.github/workflows/build-push-ghcr.yaml@master
    with:
      container-name: ${{ inputs.image }}
      context: ./${{ inputs.image }}
      file: ./${{ inputs.image }}/Dockerfile
    secrets: inherit

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
